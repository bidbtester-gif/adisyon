<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Antepli Dürümcü - Profesyonel Yönetim</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, addDoc, deleteDoc, updateDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC41Ku7gRwOltqzbbVehvRDgrIxdZhJpvA",
            authDomain: "antepli-735c6.firebaseapp.com",
            projectId: "antepli-735c6",
            storageBucket: "antepli-735c6.firebasestorage.app",
            messagingSenderId: "1006133476301",
            appId: "1:1006133476301:web:f8c0dcb8580936b33d2284"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.fs = { collection, doc, setDoc, getDoc, onSnapshot, query, addDoc, deleteDoc, updateDoc, orderBy };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; transition: background 0.3s; }
        
        body.dark { background: #0f172a; color: #f1f5f9; }
        .dark .bg-white { background: #1e293b !important; color: #f1f5f9; border-color: #334155; }
        .dark .bg-slate-50 { background: #334155 !important; color: #f1f5f9; }
        .dark .text-slate-800 { color: #ffffff !important; }
        .dark input, .dark textarea { background: #1e293b !important; color: white !important; border: 1px solid #475569; }

        .privacy-hidden { filter: blur(8px); }
        
        #login-screen { position: fixed; inset: 0; z-index: 10000; display: flex; align-items: center; justify-content: center; background: url('https://images.unsplash.com/photo-1555939594-58d7cb561ad1?q=80&w=1920') no-repeat center center; background-size: cover; }
        .login-overlay { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.75); backdrop-filter: blur(15px); }
        
        .tab-content { display: none; }
        .tab-active { display: block; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; align-items: center; justify-content: center; }

        .report-scroll { max-height: 500px; overflow-y: auto; }
        .excel-table { width: 100%; border-collapse: collapse; margin-top: 15px; color: black !important; }
        .excel-table th, .excel-table td { border: 1px solid #000; padding: 8px; text-align: left; font-size: 12px; }
        .excel-table th { background-color: #f2f2f2; font-weight: bold; }
        .pdf-print-area { background: white !important; color: black !important; padding: 40px; }

        #receipt-content { font-family: 'Courier New', Courier, monospace; background: white !important; color: black !important; padding: 15px; width: 100%; max-width: 300px; margin: 0 auto; }
        .receipt-header { text-align: center; border-bottom: 1px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }
        .receipt-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 3px; }
        .receipt-divider { border-top: 1px dashed #000; margin: 8px 0; }
        .receipt-total { font-weight: bold; font-size: 16px; display: flex; justify-content: space-between; }

        @media print {
            body * { visibility: hidden; }
            #modal, #modal *, #receipt-content, #receipt-content * { visibility: visible; }
            #modal { position: absolute; left: 0; top: 0; background: white !important; display: block !important; }
            #receipt-content { border: none; width: 100%; padding: 0; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen bg-slate-50 dark"> 

<div id="login-screen">
    <div class="login-overlay"></div>
    <div class="relative z-10 bg-white dark:bg-slate-900 p-10 rounded-[3rem] shadow-2xl w-full max-w-md text-center border border-white/10">
        <img src="anteplilogo.png" alt="Logo" class="w-30 h-auto mx-auto mb-1 drop-shadow-2xl">
        <h1 class="text-2xl font-black text-slate-800 dark:text-white mb-6 uppercase tracking-tight">Antepli Dürümcü <br> Yusuf Usta </br></h1>
        <div class="space-y-4">
            <input type="password" id="login-pass" class="w-full p-4 bg-slate-100 dark:bg-slate-800 border-none rounded-2xl focus:ring-2 focus:ring-orange-500 outline-none text-center text-xl tracking-widest transition-all" placeholder="Şifrenizi Giriniz...">
            <button onclick="checkLogin()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-4 rounded-2xl shadow-lg uppercase transition-all active:scale-95">Sisteme Giriş</button>
            <a href="a1.html" target="_blank">
                <br><br> <button class="text-sm font-semibold text-orange-500 hover:underline">Şifremi Unuttum</button>
            </a>
        </div>
    </div>
</div>

<div id="app-content" style="display:none;" class="pb-20">
    <header class="bg-white dark:bg-slate-900 border-b dark:border-slate-800 shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="anteplilogo.png" alt="Logo" class="w-10 h-10">
                <h1 class="text-xl font-bold dark:text-white uppercase" id="title-display">Antepli Dürümcü</h1>
            </div>
            
            <div class="flex items-center gap-4 bg-slate-50 dark:bg-slate-800 px-4 py-2 rounded-2xl border dark:border-slate-700">
                <button onclick="togglePrivacy()" class="text-slate-400 hover:text-orange-600"><i id="privacy-icon" class="fas fa-eye text-lg"></i></button>
                <div class="text-center">
                    <p class="text-[9px] uppercase font-bold text-slate-400">Günlük Gelir</p>
                    <p id="stat-income" class="font-black text-emerald-600">0.00 ₺</p>
                </div>
                <div class="text-center">
                    <p class="text-[9px] uppercase font-bold text-slate-400">Sipariş</p>
                    <p id="stat-count" class="font-black text-blue-600">0</p>
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="toggleDarkMode()" class="p-2.5 bg-slate-100 dark:bg-slate-800 rounded-xl dark:text-white"><i class="fas fa-adjust"></i></button>
                <button onclick="location.reload()" class="p-2.5 bg-red-50 dark:bg-red-900/20 rounded-xl text-red-600"><i class="fas fa-sync-alt"></i></button>
            </div>
        </div>
    </header>

    <nav class="bg-white dark:bg-slate-900 border-b dark:border-slate-800 overflow-x-auto p-3">
        <div class="container mx-auto flex gap-2">
            <button onclick="openTab('adisyon')" class="tab-btn px-6 py-2.5 rounded-xl font-bold text-orange-600 bg-orange-50 dark:bg-orange-900/20">SİPARİŞ</button>
            <button onclick="openTab('online-siparisler')" class="tab-btn px-6 py-2.5 rounded-xl font-bold text-slate-500">ONLINE SİPARİŞLER</button>
            <button onclick="openTab('raporlar')" class="tab-btn px-6 py-2.5 rounded-xl font-bold text-slate-500">ANALİZ & RAPOR</button>
            <button onclick="openTab('urun-yonetimi')" class="tab-btn px-6 py-2.5 rounded-xl font-bold text-slate-500">ÜRÜNLER</button>
            <button onclick="openTab('giderler')" class="tab-btn px-6 py-2.5 rounded-xl font-bold text-slate-500">GİDERLER</button>
            <button onclick="openTab('firma-ayarlar')" class="tab-btn px-6 py-2.5 rounded-xl font-bold text-slate-500">AYARLAR</button>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-6">
        <div id="adisyon" class="tab-content tab-active">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-8">
                    <div id="products-container" class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                </div>
                <div class="lg:col-span-4">
                    <div class="bg-white dark:bg-slate-900 rounded-[2rem] shadow-xl p-6 border dark:border-slate-800 sticky top-24">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-black uppercase">Yeni Adisyon</h2>
                            <button onclick="clearCart()" class="text-[10px] font-bold text-red-500 underline uppercase">Boşalt</button>
                        </div>
                        <div id="cart-items" class="space-y-3 mb-6 min-h-[100px] max-h-[40vh] overflow-y-auto"></div>
                        <div class="grid grid-cols-2 gap-2 mb-6 p-1 bg-slate-100 dark:bg-slate-800 rounded-2xl">
                            <button onclick="setPayment('Nakit')" class="pay-btn active bg-white dark:bg-slate-700 font-bold py-2 rounded-xl shadow-sm text-slate-800 dark:text-white" id="pay-cash">NAKİT</button>
                            <button onclick="setPayment('K.Kartı')" class="pay-btn text-slate-500 font-bold py-2 rounded-xl" id="pay-card">K.KARTI</button>
                        </div>
                        <div class="border-t border-dashed dark:border-slate-700 pt-6 text-center">
                            <span id="total" class="text-4xl font-black text-orange-600 block mb-6">0.00 ₺</span>
                            <button onclick="saveOrder()" class="w-full bg-orange-600 text-white font-black py-5 rounded-2xl shadow-lg uppercase tracking-widest active:scale-95">Fiş Yazdır</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="online-siparisler" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-center uppercase font-black">
                <div class="bg-pink-50 dark:bg-pink-900/10 p-6 rounded-[2rem] border border-pink-100 dark:border-pink-900/30">
                    <p class="text-xs text-pink-600 mb-2">Yemeksepeti</p>
                    <p id="ys-count" class="text-3xl">0</p>
                </div>
                <div class="bg-purple-50 dark:bg-purple-900/10 p-6 rounded-[2rem] border border-purple-100 dark:border-purple-900/30">
                    <p class="text-xs text-purple-600 mb-2">Getir Yemek</p>
                    <p id="getir-count" class="text-3xl">0</p>
                </div>
                <div class="bg-orange-50 dark:bg-orange-900/10 p-6 rounded-[2rem] border border-orange-100 dark:border-orange-900/30">
                    <p class="text-xs text-orange-600 mb-2">Migros Yemek</p>
                    <p id="migros-count" class="text-3xl">0</p>
                </div>
            </div>
            <div class="bg-white dark:bg-slate-900 p-8 rounded-[2.5rem] border dark:border-slate-800">
                <h2 class="text-2xl font-black mb-8 flex items-center gap-3">
                    <span class="flex h-3 w-3"><span class="animate-ping absolute inline-flex h-3 w-3 rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span></span>
                    GELEN SİPARİŞLER
                </h2>
                <div id="online-orders-list" class="space-y-4">
                    <p class="text-slate-400 italic text-center py-20 uppercase tracking-widest text-sm">Online Platform Alanı Güncellenmektedir...</p>
                </div>
            </div>
        </div>

        <div id="raporlar" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-4 space-y-6">
                    <div class="bg-white dark:bg-slate-900 p-6 rounded-[2rem] border dark:border-slate-800 shadow-sm">
                        <h3 class="font-black mb-4 uppercase">Rapor Sorgula</h3>
                        <label class="text-[10px] font-bold text-slate-400">GÜN SEÇ</label>
                        <input type="date" id="gunluk-tarih" class="w-full p-4 rounded-xl border dark:border-slate-700 mb-4 outline-none">
                        <button onclick="generateDetayliRapor('gunluk')" class="w-full bg-orange-600 text-white py-4 rounded-xl font-bold uppercase mb-4 shadow-md">Günü Getir</button>
                        <label class="text-[10px] font-bold text-slate-400">AY SEÇ</label>
                        <input type="month" id="aylik-ay" class="w-full p-4 rounded-xl border dark:border-slate-700 mb-4 outline-none">
                        <button onclick="generateDetayliRapor('aylik')" class="w-full bg-slate-800 dark:bg-slate-700 text-white py-4 rounded-xl font-bold uppercase shadow-md">Ayı Analiz Et</button>
                    </div>
                    <button onclick="downloadPDF()" id="pdf-btn" style="display:none;" class="w-full bg-emerald-600 text-white py-5 rounded-2xl font-black shadow-lg"><i class="fas fa-file-pdf mr-2"></i>SADE A4 PDF İNDİR</button>
                </div>

                <div class="lg:col-span-8 space-y-6">
                    <div class="bg-white dark:bg-slate-900 p-6 rounded-[2rem] border dark:border-slate-800 shadow-sm h-[350px]">
                        <h3 class="font-black mb-4 uppercase">Gelir vs Gider (Son 7 Gün)</h3>
                        <canvas id="balanceChart"></canvas>
                    </div>
                    <div class="bg-white dark:bg-slate-900 p-8 rounded-[2.5rem] border dark:border-slate-800 shadow-sm">
                        <div id="report-to-pdf">
                            <h3 class="font-black mb-4 uppercase text-orange-600" id="report-title">Detaylı Rapor</h3>
                            <div id="report-output" class="report-scroll">
                                <p class="text-slate-400 italic">Sorgulama yapıldığında detaylar burada listelenir...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="urun-yonetimi" class="tab-content">
            <div class="max-w-4xl mx-auto bg-white dark:bg-slate-900 p-8 rounded-[2.5rem] border dark:border-slate-800">
                <h2 class="text-2xl font-black mb-6">Menü Düzenle</h2>
                <div class="flex flex-wrap gap-4 mb-8 bg-slate-50 dark:bg-slate-800 p-6 rounded-2xl border dark:border-slate-700">
                    <input id="product-name" placeholder="Ürün Adı" class="flex-1 p-4 rounded-xl outline-none">
                    <input id="product-price" type="number" placeholder="Fiyat" class="w-32 p-4 rounded-xl outline-none">
                    <button onclick="dbAddProduct()" class="bg-orange-600 text-white px-8 py-4 rounded-xl font-black shadow-md">EKLE</button>
                </div>
                <div id="product-list" class="grid gap-2"></div>
            </div>
        </div>

        <div id="giderler" class="tab-content">
            <div class="max-w-4xl mx-auto bg-white dark:bg-slate-900 p-8 rounded-[2.5rem] border dark:border-slate-800">
                <h2 class="text-2xl font-black mb-6 text-red-600 uppercase">Gider Kayıtları</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 bg-red-50 dark:bg-red-900/10 p-6 rounded-2xl border border-red-100 dark:border-red-900/30">
                    <input id="gider-aciklama" placeholder="Gider Açıklaması" class="md:col-span-2 p-4 rounded-xl border dark:border-slate-700">
                    <input id="gider-tutar" type="number" placeholder="Tutar" class="p-4 rounded-xl border dark:border-slate-700">
                    <button onclick="dbAddGider()" class="bg-red-600 text-white py-4 rounded-xl font-black shadow-md">İŞLE</button>
                </div>
                <div id="gider-list" class="space-y-2"></div>
            </div>
        </div>

        <div id="firma-ayarlar" class="tab-content">
            <div class="max-w-2xl mx-auto bg-white dark:bg-slate-900 p-10 rounded-[2.5rem] border dark:border-slate-800">
                <h2 class="text-2xl font-black mb-8">İşletme Bilgileri</h2>
                <div class="space-y-4">
                    <input id="firma-ismi" placeholder="İşletme Adı" class="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-800 border dark:border-slate-700">
                    <input id="firma-telefon" placeholder="Telefon" class="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-800 border dark:border-slate-700">
                    <textarea id="firma-adres" placeholder="Adres Bilgisi" rows="3" class="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-800 border dark:border-slate-700"></textarea>
                    <button onclick="dbUpdateFirma()" class="w-full bg-slate-800 dark:bg-orange-600 text-white py-5 rounded-2xl font-black shadow-lg">BİLGİLERİ GÜNCELLE</button>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center py-10 text-slate-400 font-black tracking-widest uppercase">
        CODERK Software
    </footer>
</div>

<div id="modal">
    <div class="bg-white p-8 rounded-[2rem] w-full max-w-sm m-4 shadow-2xl">
        <div id="receipt-content"></div>
        <div class="grid grid-cols-2 gap-4 no-print mt-6">
            <button onclick="window.print()" class="bg-orange-600 text-white py-4 rounded-xl font-black shadow-lg">YAZDIR</button>
            <button onclick="closeModal()" class="bg-slate-100 text-slate-600 py-4 rounded-xl font-black">KAPAT</button>
        </div>
    </div>
</div>

<script>
    let products = []; let orders = []; let giderler = []; let onlineOrders = [];
    let firma = { ismi: "Antepli Dürümcü", adres: "", telefon: "" };
    let cart = {}; let currentPayment = 'Nakit'; let isPrivacyOn = false;
    let balanceChart = null;

    function checkLogin() {
        if(document.getElementById('login-pass').value === "1234") {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            startFirebaseSync();
        } else { alert("Hatalı Şifre!"); }
    }

    function togglePrivacy() {
        isPrivacyOn = !isPrivacyOn;
        document.getElementById('privacy-icon').className = isPrivacyOn ? 'fas fa-eye-slash' : 'fas fa-eye';
        document.getElementById('stat-income').classList.toggle('privacy-hidden', isPrivacyOn);
    }

    function startFirebaseSync() {
        window.fs.onSnapshot(window.fs.collection(window.db, "products"), (snap) => {
            products = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderProducts(); renderProductList();
        });
        window.fs.onSnapshot(window.fs.collection(window.db, "orders"), (snap) => {
            orders = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateStats(); updateChart();
        });
        window.fs.onSnapshot(window.fs.collection(window.db, "expenses"), (snap) => {
            giderler = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateChart(); renderGiderList();
        });
        // ONLINE SİPARİŞLERİ TAKİP ET
        window.fs.onSnapshot(window.fs.collection(window.db, "online_orders"), (snap) => {
            onlineOrders = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderOnlineOrders();
        });
        window.fs.onSnapshot(window.fs.doc(window.db, "settings", "firma"), (doc) => {
            if(doc.exists()) { 
                firma = doc.data(); 
                document.getElementById('title-display').innerText = firma.ismi;
                document.getElementById('firma-ismi').value = firma.ismi;
                document.getElementById('firma-telefon').value = firma.telefon;
                document.getElementById('firma-adres').value = firma.adres;
            }
        });
    }

    // ONLINE SİPARİŞ RENDER
    function renderOnlineOrders() {
        const container = document.getElementById('online-orders-list');
        document.getElementById('ys-count').innerText = onlineOrders.filter(o => o.platform === 'Yemeksepeti').length;
        document.getElementById('getir-count').innerText = onlineOrders.filter(o => o.platform === 'Getir').length;
        document.getElementById('migros-count').innerText = onlineOrders.filter(o => o.platform === 'Migros').length;

        if(onlineOrders.length === 0) {
            container.innerHTML = `<p class="text-slate-400 italic text-center py-20 uppercase tracking-widest text-sm">Online Sipariş Platformu Güncellenmektedir...</p>`;
            return;
        }

        container.innerHTML = onlineOrders.map(o => `
            <div class="flex flex-col md:flex-row justify-between items-center p-6 bg-slate-50 dark:bg-slate-800 rounded-[2rem] border dark:border-slate-700 gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-white dark:bg-slate-700 flex items-center justify-center rounded-2xl font-black text-xl shadow-sm text-orange-600">${o.platform[0]}</div>
                    <div>
                        <div class="font-black text-sm uppercase">${o.customer || 'İsimsiz Müşteri'}</div>
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${o.platform} • ${o.time || 'Şimdi'}</div>
                    </div>
                </div>
                <div class="text-center md:text-right">
                    <div class="font-black text-emerald-600 text-lg">${parseFloat(o.total).toFixed(2)} ₺</div>
                    <div class="text-[9px] text-slate-500 font-bold">${o.items_summary || 'Menü Detayı'}</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="approveOnlineOrder('${o.id}')" class="bg-orange-600 text-white px-6 py-3 rounded-xl font-black text-[10px] uppercase shadow-lg active:scale-95">ONAYLA</button>
                    <button onclick="deleteOnlineOrder('${o.id}')" class="text-red-500 p-3"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `).join('');
    }

    async function approveOnlineOrder(id) {
        alert('Sipariş Onaylandı ve Arşive Alındı!');
        await window.fs.deleteDoc(window.fs.doc(window.db, "online_orders", id));
    }

    async function deleteOnlineOrder(id) {
        if(confirm('Siparişi silmek istiyor musunuz?')) await window.fs.deleteDoc(window.fs.doc(window.db, "online_orders", id));
    }

    function updateChart() {
        const ctx = document.getElementById('balanceChart').getContext('2d');
        const last7Days = [...Array(7)].map((_, i) => {
            const d = new Date(); d.setDate(d.getDate() - i);
            return d.toISOString().split('T')[0];
        }).reverse();
        const salesData = last7Days.map(date => orders.filter(o => o.date.startsWith(date)).reduce((s, o) => s + o.total, 0));
        const expenseData = last7Days.map(date => giderler.filter(g => g.tarih === date).reduce((s, g) => s + g.tutar, 0));
        if(balanceChart) balanceChart.destroy();
        balanceChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: last7Days.map(d => d.split('-').reverse().slice(0,2).join('/')),
                datasets: [
                    { label: 'Gelir (₺)', data: salesData, backgroundColor: '#10b981', borderRadius: 5 },
                    { label: 'Gider (₺)', data: expenseData, backgroundColor: '#ef4444', borderRadius: 5 }
                ]
            },
            options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    }

    function generateDetayliRapor(tip) {
        const selector = tip === 'gunluk' ? 'gunluk-tarih' : 'aylik-ay';
        const val = document.getElementById(selector).value;
        if(!val) { alert("Lütfen tarih seçin!"); return; }
        const filteredOrders = orders.filter(o => o.date.startsWith(val));
        const filteredExpenses = giderler.filter(g => g.tarih.startsWith(val));
        
        let html = `<div class="pdf-print-area">
            <h2 style="text-align:center; text-transform:uppercase; margin-bottom:5px;">${firma.ismi} RAPORU</h2>
            <p style="text-align:center; font-size:12px; margin-bottom:20px;">Dönem: ${val}</p>
            <div style="margin-bottom:20px; font-size:14px;">
                <p><b>Toplam Gelir:</b> ${filteredOrders.reduce((s,o)=>s+o.total,0).toFixed(2)} ₺</p>
                <p><b>Toplam Gider:</b> ${filteredExpenses.reduce((s,g)=>s+g.tutar,0).toFixed(2)} ₺</p>
                <p><b>Net Kar/Zarar:</b> ${(filteredOrders.reduce((s,o)=>s+o.total,0) - filteredExpenses.reduce((s,g)=>s+g.tutar,0)).toFixed(2)} ₺</p>
            </div>
            <table class="excel-table">
                <thead><tr><th>No</th><th>Saat</th><th>Ürünler</th><th>Ödeme</th><th>Tutar</th></tr></thead>
                <tbody>`;
        filteredOrders.forEach((o, i) => {
            const time = o.date.split('T')[1].substring(0,5);
            const items = o.items.map(it => `${it.name}(${it.quantity})`).join(', ');
            html += `<tr><td>${i+1}</td><td>${time}</td><td>${items}</td><td>${o.payment}</td><td>${o.total.toFixed(2)} ₺</td></tr>`;
        });
        html += `</tbody></table>`;
        if(filteredExpenses.length > 0){
            html += `<h4 style="margin-top:30px; margin-bottom:10px; border-bottom:1px solid #000;">GİDER DETAYLARI</h4>
            <table class="excel-table"><thead><tr><th>Açıklama</th><th>Tutar</th></tr></thead><tbody>`;
            filteredExpenses.forEach(g => { html += `<tr><td>${g.aciklama}</td><td>${g.tutar.toFixed(2)} ₺</td></tr>`; });
            html += `</tbody></table>`;
        }
        html += `<p style="margin-top:40px; text-align:right; font-size:10px;">CODERK Software Raporlama Sistemi</p></div>`;
        document.getElementById('report-output').innerHTML = html;
        document.getElementById('report-title').innerText = tip === 'gunluk' ? 'GÜNLÜK ÖZET' : 'AYLIK ANALİZ';
        document.getElementById('pdf-btn').style.display = 'block';
    }

    function downloadPDF() {
        const element = document.querySelector('.pdf-print-area');
        const opt = { margin: 0, filename: 'Antepli_Rapor.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
        html2pdf().set(opt).from(element).save();
    }

    function showReceipt(order) {
        let itemsHtml = order.items.map(i => `
            <div class="receipt-row">
                <span>${i.quantity} x ${i.name.toUpperCase()}</span>
                <span>${(i.price * i.quantity).toFixed(2)}₺</span>
            </div>
        `).join('');
        let content = `
            <div class="receipt-header">
                <h2 style="font-weight:900; font-size:18px; margin:0;">${firma.ismi.toUpperCase()}</h2>
                <p style="font-size:11px; margin:5px 0;">${firma.adres || ''}<br>Tel: ${firma.telefon || ''}</p>
                <p style="font-size:11px; margin:0;">Tarih: ${new Date().toLocaleString('tr-TR')}</p>
            </div>
            <div class="receipt-body">${itemsHtml}</div>
            <div class="receipt-divider"></div>
            <div class="receipt-total"><span>TOPLAM</span><span>${order.total.toFixed(2)}₺</span></div>
            <div class="receipt-row" style="margin-top:5px;"><span>ÖDEME</span><span style="font-weight:bold;">${order.payment.toUpperCase()}</span></div>
            <div class="receipt-divider"></div>
            <div style="text-align:center; font-size:12px; font-weight:bold;">AFİYET OLSUN<br><span style="font-size:9px; font-weight:normal;">Yine Bekleriz</span></div>
        `;
        document.getElementById('receipt-content').innerHTML = content;
        document.getElementById('modal').style.display = 'flex';
    }

    async function dbAddProduct() {
        const name = document.getElementById('product-name').value;
        const price = parseFloat(document.getElementById('product-price').value);
        if(name && price) { await window.fs.addDoc(window.fs.collection(window.db, "products"), { name, price }); document.getElementById('product-name').value = ''; document.getElementById('product-price').value = ''; }
    }
    async function dbDeleteProduct(id) { if(confirm('Silmek istediğinize emin misiniz?')) await window.fs.deleteDoc(window.fs.doc(window.db, "products", id)); }
    async function dbEditProduct(id, n, p) {
        const nn = prompt("Yeni isim:", n); const np = prompt("Yeni fiyat:", p);
        if(nn && np) await window.fs.updateDoc(window.fs.doc(window.db, "products", id), { name: nn, price: parseFloat(np) });
    }
    async function dbAddGider() {
        const aciklama = document.getElementById('gider-aciklama').value;
        const tutar = parseFloat(document.getElementById('gider-tutar').value);
        if(aciklama && tutar) { await window.fs.addDoc(window.fs.collection(window.db, "expenses"), { aciklama, tutar, tarih: new Date().toISOString().split('T')[0] }); document.getElementById('gider-aciklama').value = ''; document.getElementById('gider-tutar').value = ''; }
    }
    async function dbDeleteGider(id) { if(confirm('Gideri sil?')) await window.fs.deleteDoc(window.fs.doc(window.db, "expenses", id)); }
    async function dbEditGider(id, a, t) {
        const na = prompt("Yeni açıklama:", a); const nt = prompt("Yeni tutar:", t);
        if(na && nt) await window.fs.updateDoc(window.fs.doc(window.db, "expenses", id), { aciklama: na, tutar: parseFloat(nt) });
    }
    async function dbUpdateFirma() {
        const data = { ismi: document.getElementById('firma-ismi').value, telefon: document.getElementById('firma-telefon').value, adres: document.getElementById('firma-adres').value };
        await window.fs.setDoc(window.fs.doc(window.db, "settings", "firma"), data); alert("Güncellendi!");
    }

    function renderProducts() {
        document.getElementById('products-container').innerHTML = products.map(p => `
            <div onclick="addToCart('${p.id}')" class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] text-center shadow-sm border dark:border-slate-700 hover:border-orange-500 cursor-pointer active:scale-95 transition-all">
                <div class="font-black text-slate-800 dark:text-white mb-1 uppercase text-xs">${p.name}</div>
                <div class="text-orange-600 font-black text-xl">${parseFloat(p.price).toFixed(2)} ₺</div>
            </div>`).join('');
    }
    function renderProductList() {
        document.getElementById('product-list').innerHTML = products.map(p => `
            <div class="flex justify-between items-center p-4 bg-white dark:bg-slate-800 rounded-xl border dark:border-slate-700 mb-2">
                <span class="font-bold uppercase text-xs">${p.name} - ${p.price} ₺</span>
                <div class="flex gap-2">
                    <button onclick="dbEditProduct('${p.id}','${p.name}',${p.price})" class="text-blue-500 p-2"><i class="fas fa-edit"></i></button>
                    <button onclick="dbDeleteProduct('${p.id}')" class="text-red-500 p-2"><i class="fas fa-trash"></i></button>
                </div>
            </div>`).join('');
    }
    function renderGiderList() {
        document.getElementById('gider-list').innerHTML = giderler.map(g => `
            <div class="flex justify-between items-center p-4 bg-white dark:bg-slate-800 rounded-xl border dark:border-slate-700 mb-2">
                <span class="font-bold uppercase text-xs">${g.aciklama} - ${g.tutar} ₺</span>
                <div class="flex gap-2">
                    <button onclick="dbEditGider('${g.id}','${g.aciklama}',${g.tutar})" class="text-blue-500 p-2"><i class="fas fa-edit"></i></button>
                    <button onclick="dbDeleteGider('${g.id}')" class="text-red-500 p-2"><i class="fas fa-trash"></i></button>
                </div>
            </div>`).join('');
    }

    function addToCart(id) { if(!cart[id]) cart[id] = {...products.find(x => x.id === id), quantity: 0}; cart[id].quantity++; renderCart(); }
    function removeFromCart(id) { if(cart[id]) { cart[id].quantity--; if(cart[id].quantity <= 0) delete cart[id]; renderCart(); } }
    function renderCart() {
        let t = 0; const items = Object.values(cart).filter(i => i.quantity > 0);
        document.getElementById('cart-items').innerHTML = items.map(i => {
            t += i.price * i.quantity;
            return `<div class="flex justify-between items-center bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl border dark:border-slate-700">
                <div class="flex-1"><div class="font-bold text-xs uppercase">${i.name}</div><div class="text-[10px] font-black text-orange-600">${i.quantity} x ${i.price} ₺</div></div>
                <button onclick="removeFromCart('${i.id}')" class="w-8 h-8 flex items-center justify-center bg-red-100 text-red-600 rounded-lg"><i class="fas fa-times"></i></button>
            </div>`;
        }).join('') || `<div class="text-center py-10 text-slate-300 italic text-sm">Sepet boş...</div>`;
        document.getElementById('total').innerText = t.toFixed(2) + " ₺";
    }
    function updateStats() {
        const day = new Date().toISOString().split('T')[0];
        const tOrders = orders.filter(o => o.date.startsWith(day));
        document.getElementById('stat-income').innerText = tOrders.reduce((s, o) => s + o.total, 0).toFixed(2) + " ₺";
        document.getElementById('stat-count').innerText = tOrders.length;
    }
    async function saveOrder() {
        const items = Object.values(cart).filter(i => i.quantity > 0); if(!items.length) return;
        const oData = { date: new Date().toISOString(), total: parseFloat(document.getElementById('total').innerText), payment: currentPayment, items: items };
        await window.fs.addDoc(window.fs.collection(window.db, "orders"), oData); showReceipt(oData); clearCart();
    }
    function toggleDarkMode() { document.body.classList.toggle('dark'); }
    function setPayment(type) {
        currentPayment = type;
        document.querySelectorAll('.pay-btn').forEach(b => b.classList.remove('bg-white', 'dark:bg-slate-700', 'text-slate-800', 'active'));
        document.getElementById(type === 'Nakit' ? 'pay-cash' : 'pay-card').classList.add('bg-white', 'dark:bg-slate-700', 'text-slate-800', 'active');
    }
    function clearCart() { cart = {}; renderCart(); }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function openTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('tab-active'));
        document.getElementById(id).classList.add('tab-active');
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('text-orange-600', 'bg-orange-50', 'dark:bg-orange-900/20');
            b.classList.add('text-slate-500');
        });
        event.currentTarget.classList.add('text-orange-600', 'bg-orange-50', 'dark:bg-orange-900/20');
        event.currentTarget.classList.remove('text-slate-500');
    }
</script>
</body>
</html>
